<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Focus time — History</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <nav class="nav-bar">
    <div><a class="logo" href="../stopwatch/StopWatch.html">Focus Time</a></div>
    
  </nav>
    <div class="content">
      <div class="containerstop">
      <h1>STOPWATCH</h1>
      <div class="radio-btn">
        <label
          ><input type="radio" name="stopOption" value="mousemove" checked />
          마우스 모션 스탑</label
        >
        <label
          ><input type="radio" name="stopOption" value="click" /> 버튼
          스탑</label
        >
      </div>
      <div class="main-container">
        <div class="stopwatch-watch">00:00:00:00</div>
        <span> </span>
  
        <div class="stopwatch-buttons">
          <button class="startBtn" onclick="start()">START</button>
          <button class="pauseBtn" onclick="pause()">STOP</button>
          <button class="resetBtn" onclick="reset()">RESET</button>
        </div>
      </div>
      <div class="timer-btn">
        <button id="timer-page">Timer <i class="fa-solid fa-play"></i></button>
      </div>
    </div>

    <footer class="footer">
    <div class="footer-container">
      <div class="first-footer">
          <i class="fa-brands fa-facebook"></i>
          <i class="fa-brands fa-twitter"></i>
          <i class="fa-brands fa-instagram"></i>
        </div>
      </div>
      <div class="second-footer">
        <ul>
              <li><a href="#">HOME</a></li>
              <li><a href="#">TERMS OF USE</a></li>
              <li> <a href="#">PRIVACY</a></li>
              <li><a href="#">COMMERCE</a></li>
              <li><a href="#">NOONA GROUP</a></li>
              <li><a href="../index.html">ABOUT US</a></li>
          </ul>
      </div>
      <div class="third-footer">
        Copyright © Noona JavaScript PR3 2025 All Rights Reserved.
      </div>
      </div>
      
    </div>
  </footer>
      <main class="right">
        <div class="topbar">
          <div class="topbar-left">날짜 선택</div>
          <div class="topbar-right">
            <button id="chartBtn" class="chart-btn">Chart</button>
          </div>
        </div>

        <!-- ▼ 차트 3종 (상단에 추가) -->
        <section id="charts" class="charts">
          <!-- 전체 집중한 시간 -->
          <article class="chart-card" id="focusBarsCard"></article>

          <!-- 목표 달성 시간 -->
          <article class="chart-card" id="goalCard"></article>

          <!-- 프로젝트 시간 비율 -->
          <article class="chart-card wide" id="donutCard"></article>
        </section>

        <!-- ▼ 기존 연간 달력 카드/월 상세 패널 등은 그대로 유지 -->
        <section
          id="calendarGrid"
          class="calendar-grid"
          aria-label="연간 히스토리 달력"
        ></section>
        <div
          id="monthDetail"
          class="month-detail"
          aria-hidden="true"
          data-open="false"
        >
          <div
            class="month-detail-inner"
            role="region"
            aria-label="month detail"
          >
            <!-- JS가 여기서 큰 달력과 task list 렌더링 -->
          </div>
          <button
            id="monthDetailClose"
            class="month-detail-close"
            aria-label="닫기"
          >
            ×
          </button>
        </div>
      </main>
    </div>

    <!-- 중앙 핵심: StopWatch/Timer를 '하나만' 주입하고 내부 하단 토글 버튼으로 전환 -->
    <script>
      // 이전에 주입한 리소스 제거
      function cleanupInjected() {
        const root = document.getElementById('stopwatchRoot');
        if (root) root.innerHTML = '';
        document
          .querySelectorAll('[data-injected]')
          .forEach((el) => el.remove());
        try {
          if (window.Timer && typeof window.Timer.destroy === 'function')
            window.Timer.destroy();
        } catch (e) {}
        try {
          if (
            window.StopWatch &&
            typeof window.StopWatch.destroy === 'function'
          )
            window.StopWatch.destroy();
        } catch (e) {}
      }

      // HTML 텍스트에서 핵심 카드 노드만 추출 (전역 header/nav 제거, 내부 버튼 유지)
      function extractMainNodeFromHTML(htmlText) {
        const doc = new DOMParser().parseFromString(htmlText, 'text/html');
        const candidate =
          doc.querySelector('.container') ||
          doc.querySelector('.stopwatch') ||
          doc.querySelector('.timer') ||
          doc.querySelector('.card') ||
          doc.querySelector('main') ||
          doc.body;
        const node = candidate.cloneNode(true);
        node
          .querySelectorAll('header, .page-header, .title, nav, .nav-bar')
          .forEach((el) => el.remove());
        // Prevent injected links from navigating away; convert timer/stopwatch links to buttons later
        Array.from(node.querySelectorAll('a')).forEach((a) =>
          a.removeAttribute('href')
        );
        return node;
      }

      function injectStyleLink(href, tag) {
        if (document.querySelector('link[data-injected="' + tag + '"]')) return;
        const l = document.createElement('link');
        l.rel = 'stylesheet';
        l.href = href;
        l.setAttribute('data-injected', tag);
        document.head.appendChild(l);
      }
      function injectScriptSrc(src, tag) {
        if (document.querySelector('script[data-injected="' + tag + '"]'))
          return;
        const s = document.createElement('script');
        s.src = src;
        s.setAttribute('data-injected', tag);
        document.body.appendChild(s);
      }

      // 공통: 변환 - 노드 내부에서 a 태그를 버튼으로 바꿔 내부 토글을 연결
      function convertInternalLinks(node) {
        Array.from(node.querySelectorAll('a')).forEach((a) => {
          const text = a.innerHTML;
          const isTimer =
            /\/timer|timer\.html/i.test(a.getAttribute('href') || '') ||
            /timer/i.test(a.textContent || '');
          const isStopwatch =
            /\/stopwatch|stopwatch\.html/i.test(a.getAttribute('href') || '') ||
            /stopwatch/i.test(a.textContent || '');
          if (isTimer || isStopwatch) {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = a.className || '';
            btn.innerHTML = text;
            if (isTimer)
              btn.addEventListener('click', () => window.loadTimerLocal());
            if (isStopwatch)
              btn.addEventListener('click', () => window.loadStopwatchLocal());
            a.replaceWith(btn);
          } else {
            // neutralize other links
            const span = document.createElement('span');
            span.innerHTML = text;
            a.replaceWith(span);
          }
        });
      }

      // StopWatch 삽입 (로컬 파일)
      async function loadStopwatchLocal() {
        cleanupInjected();
        const root = document.getElementById('stopwatchRoot');
        if (!root) return;
        try {
          const res = await fetch('../stopwatch/StopWatch.html');
          if (!res.ok) throw new Error('StopWatch fetch failed: ' + res.status);
          const txt = await res.text();
          injectStyleLink('../stopwatch/StopWatch.css', 'stopwatch-css');
          // append script after injecting DOM so it can bind
          const node = extractMainNodeFromHTML(txt);
          node.setAttribute('data-injected', 'stopwatch-node');

          // ensure single internal toggle button (id="timer-page")
          if (!node.querySelector('#timer-page')) {
            const wrap = document.createElement('div');
            wrap.className = 'stopwatch-btn';
            const btn = document.createElement('button');
            btn.id = 'timer-page';
            btn.textContent = 'Timer';
            wrap.appendChild(btn);
            node.appendChild(wrap);
          }

          convertInternalLinks(node);
          root.appendChild(node);
          injectScriptSrc('../stopwatch/StopWatch.js', 'stopwatch-script');

          // bind internal toggle
          setTimeout(() => {
            const btn = document.getElementById('timer-page');
            if (btn)
              btn.onclick = async (e) => {
                e.preventDefault();
                await loadTimerLocal();
              };
          }, 120);
        } catch (err) {
          console.error('loadStopwatchLocal error', err);
        }
      }

      // Timer 삽입 (로컬 파일) — 사용자가 제공한 구조를 그대로 로드
      async function loadTimerLocal() {
        cleanupInjected();
        const root = document.getElementById('stopwatchRoot');
        if (!root) return;
        try {
          const res = await fetch('../timer/Timer.html');
          if (!res.ok) throw new Error('Timer fetch failed: ' + res.status);
          const txt = await res.text();
          injectStyleLink('../timer/Timer.css', 'timer-css');

          const node = extractMainNodeFromHTML(txt);
          node.setAttribute('data-injected', 'timer-node');

          // ensure single internal toggle button (id="stopwatch-page")
          if (!node.querySelector('#stopwatch-page')) {
            const wrap = document.createElement('div');
            wrap.className = 'stopwatch-btn';
            const btn = document.createElement('button');
            btn.id = 'stopwatch-page';
            btn.textContent = 'Stopwatch';
            wrap.appendChild(btn);
            node.appendChild(wrap);
          }

          convertInternalLinks(node);
          root.appendChild(node);
          injectScriptSrc('../timer/Timer.js', 'timer-script');

          // bind internal toggle
          setTimeout(() => {
            const btn = document.getElementById('stopwatch-page');
            if (btn)
              btn.onclick = async (e) => {
                e.preventDefault();
                await loadStopwatchLocal();
              };
          }, 120);
        } catch (err) {
          console.error('loadTimerLocal error', err);
        }
      }

      // 전역으로 노출해 내부 변환에서도 호출 가능
      window.loadStopwatchLocal = loadStopwatchLocal;
      window.loadTimerLocal = loadTimerLocal;

      // 초기 로드: 스탑워치 표시, 우측 달력(app.js) 영향 없음
      document.addEventListener('DOMContentLoaded', () => {
        loadStopwatchLocal();
      });
    </script>

    <!-- 반드시 history 캘린더 스크립트는 유지 -->
    <script src="app.js"></script>
    <script>
      // 좌측 내부에서 발생하는 <a> 클릭을 가로채서 페이지 이동을 막고,
      // 대신 좌측 영역을 교체하도록 로더를 호출합니다.
      document.addEventListener(
        'click',
        (ev) => {
          const a = ev.target.closest && ev.target.closest('a');
          if (!a) return;
          const href = (a.getAttribute('href') || '').toLowerCase();

          // 로컬 타이머/스톱워치 경로가 포함된 링크면 네비게이션 차단 후 내부 로드
          if (href.includes('/timer') || href.endsWith('timer.html')) {
            ev.preventDefault();
            if (typeof window.loadTimerLocal === 'function') {
              window.loadTimerLocal();
            }
            return;
          }
          if (
            href.includes('/stopwatch') ||
            href.endsWith('stopwatch.html') ||
            href.endsWith('stopwatch')
          ) {
            ev.preventDefault();
            if (typeof window.loadStopwatchLocal === 'function') {
              window.loadStopwatchLocal();
            }
            return;
          }

          // 그 외 로컬 링크(프로젝트 내부)로 바로 가는 것도 방지하고 싶으면 아래 주석을 해제
          // if (href.startsWith('/') || href.startsWith(window.location.origin)) { ev.preventDefault(); }
        },
        { capture: true }
      );

      // #stopwatchRoot 내부 클릭을 가로채 네비게이션 차단 및 내부 뷰 토글 강제
      document.addEventListener(
        'click',
        function (e) {
          const root = document.getElementById('stopwatchRoot');
          if (!root) return;
          const target =
            e.target.closest &&
            e.target.closest(
              '#timer-page, #stopwatch-page, #left-toggle, a, button'
            );
          if (!target) return;

          // 내부 토글 버튼 처리 (페이지 이동 금지)
          if (target.id === 'timer-page') {
            e.preventDefault();
            e.stopPropagation();
            if (typeof window.loadTimerLocal === 'function')
              window.loadTimerLocal();
            return;
          }
          if (target.id === 'stopwatch-page' || target.id === 'left-toggle') {
            e.preventDefault();
            e.stopPropagation();
            if (typeof window.loadStopwatchLocal === 'function')
              window.loadStopwatchLocal();
            return;
          }

          // #stopwatchRoot 내부의 다른 <a> 태그 클릭이면 기본 이동 차단
          if (root.contains(target) && target.tagName === 'A') {
            e.preventDefault();
            e.stopPropagation();
            return;
          }

          // 버튼 요소가 내부에 있고 기본 동작이 있을 수 있으므로 안전 차단
          if (
            root.contains(target) &&
            (target.tagName === 'BUTTON' || target.tagName === 'INPUT')
          ) {
            // 허용할 내부 버튼 이벤트는 이미 바인딩되어 있으므로 여기서는 이동만 차단
            e.stopPropagation();
          }
        },
        true
      );
    </script>
  </body>
</html>
